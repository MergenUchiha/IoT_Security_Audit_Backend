// IoT Security Audit System - Prisma Schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Device Status Enum
enum DeviceStatus {
  online
  offline
  warning
}

// Risk Level Enum
enum RiskLevel {
  critical
  high
  medium
  low
}

// Vulnerability Status Enum
enum VulnerabilityStatus {
  open
  patched
  mitigated
}

// Scan Status Enum
enum ScanStatus {
  pending
  running
  completed
  failed
}

// Device Model
model Device {
  id              String        @id @default(uuid())
  name            String
  ip              String        @unique
  type            String        // Camera, IoT Sensor, Access Control, etc.
  status          DeviceStatus  @default(online)
  risk            RiskLevel     @default(medium)
  manufacturer    String
  firmware        String
  ports           Int[]
  services        String[]
  
  // Metrics
  vulnerabilities Int           @default(0)
  lastScan        DateTime?
  
  // Relations
  scans           Scan[]
  deviceVulns     DeviceVulnerability[]
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([status])
  @@index([risk])
  @@map("devices")
}

// Vulnerability Model (CVE Database)
model Vulnerability {
  id            String                @id // CVE-XXXX-XXXX
  title         String
  severity      RiskLevel
  cvss          Float
  description   String                @db.Text
  impact        String                @db.Text
  solution      String                @db.Text
  discovered    DateTime
  
  // Relations
  deviceVulns   DeviceVulnerability[]
  scanFindings  ScanFinding[]
  
  createdAt     DateTime              @default(now())
  updatedAt     DateTime              @updatedAt

  @@index([severity])
  @@map("vulnerabilities")
}

// Device-Vulnerability Relationship (many-to-many with status)
model DeviceVulnerability {
  id              String                @id @default(uuid())
  deviceId        String
  device          Device                @relation(fields: [deviceId], references: [id], onDelete: Cascade)
  vulnerabilityId String
  vulnerability   Vulnerability         @relation(fields: [vulnerabilityId], references: [id], onDelete: Cascade)
  status          VulnerabilityStatus   @default(open)
  detectedAt      DateTime              @default(now())
  
  @@unique([deviceId, vulnerabilityId])
  @@index([deviceId])
  @@index([vulnerabilityId])
  @@map("device_vulnerabilities")
}

// Scan Model
model Scan {
  id          String      @id @default(uuid())
  deviceId    String
  device      Device      @relation(fields: [deviceId], references: [id], onDelete: Cascade)
  
  type        String      // full, firmware, network, ports
  status      ScanStatus  @default(pending)
  startTime   DateTime    @default(now())
  endTime     DateTime?
  duration    Int?        // seconds
  
  // Phases progress
  phases      Json        // Array of scan phases with progress
  
  // Results
  findings    ScanFinding[]
  
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@index([deviceId])
  @@index([status])
  @@index([startTime])
  @@map("scans")
}

// Scan Finding (vulnerabilities found in a scan)
model ScanFinding {
  id              String        @id @default(uuid())
  scanId          String
  scan            Scan          @relation(fields: [scanId], references: [id], onDelete: Cascade)
  vulnerabilityId String
  vulnerability   Vulnerability @relation(fields: [vulnerabilityId], references: [id])
  
  details         String        @db.Text
  evidence        Json?         // Screenshots, logs, etc.
  
  createdAt       DateTime      @default(now())

  @@index([scanId])
  @@map("scan_findings")
}

// Network Traffic Model
model NetworkTraffic {
  id            String    @id @default(uuid())
  timestamp     DateTime  @default(now())
  
  // Traffic metrics
  incoming      Int       @default(0)
  outgoing      Int       @default(0)
  suspicious    Int       @default(0)
  
  // Period (for aggregation)
  period        String    // "00:00", "00:05", etc.
  
  @@index([timestamp])
  @@map("network_traffic")
}

// Security Metrics Model
model SecurityMetrics {
  id                  String   @id @default(uuid())
  timestamp           DateTime @default(now())
  
  // Device metrics
  devicesOnline       Int      @default(0)
  totalDevices        Int      @default(0)
  
  // Vulnerability metrics
  totalVulnerabilities Int     @default(0)
  criticalIssues      Int      @default(0)
  highIssues          Int      @default(0)
  mediumIssues        Int      @default(0)
  lowIssues           Int      @default(0)
  
  // Scan metrics
  activeScans         Int      @default(0)
  completedScans      Int      @default(0)
  
  // Compliance scores
  owaspScore          Float    @default(0)
  nistScore           Float    @default(0)
  gdprScore           Float    @default(0)
  iso27001Score       Float    @default(0)
  cisScore            Float    @default(0)
  
  @@index([timestamp])
  @@map("security_metrics")
}

// Vulnerability Trend Model (historical data)
model VulnerabilityTrend {
  id        String   @id @default(uuid())
  month     String   // "Jan", "Feb", etc.
  year      Int
  
  critical  Int      @default(0)
  high      Int      @default(0)
  medium    Int      @default(0)
  low       Int      @default(0)
  
  createdAt DateTime @default(now())

  @@unique([month, year])
  @@index([year])
  @@map("vulnerability_trends")
}

// Activity Log Model
model ActivityLog {
  id          String   @id @default(uuid())
  type        String   // scan, alert, update, info
  message     String
  device      String?
  severity    String   // critical, high, medium, low, info
  timestamp   DateTime @default(now())
  
  details     Json?
  
  @@index([timestamp])
  @@index([type])
  @@map("activity_logs")
}

// Report Model
model Report {
  id              String   @id @default(uuid())
  title           String
  type            String   // technical, executive, compliance
  status          String   // draft, final
  
  // Content
  devices         Int      @default(0)
  vulnerabilities Int      @default(0)
  findings        Json?
  recommendations Json?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([type])
  @@index([createdAt])
  @@map("reports")
}